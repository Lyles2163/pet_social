# 宠物社交平台后端服务 - 开发日志
## 项目概述
本项目是一个基于 Node.js + Express 的宠物社交平台后端服务，提供用户认证、宠物信息管理、帖子发布与互动、搜索等核心功能。项目采用现代化的技术栈，注重性能优化和用户体验。

开发者 : 计应2305李阳
项目版本 : 1.0.0
最后更新 : 2025年6月12日 
服务端口 : 3000 
技术支持 : Node.js + Express + MySQL + Redis

## 技术架构
### 核心技术选型
- Node.js + Express : 选择了轻量级、高性能的 Node.js 运行时和 Express 框架来构建后端 API 服务。Express 提供了简洁的路由定义和中间件机制，便于快速开发和组织代码。
- MySQL : 使用 MySQL 作为主要的关系型数据库，用于存储用户、宠物、帖子、评论、标签、搜索记录等结构化数据。通过 mysql2/promise 库，可以使用 async/await 语法进行数据库操作，使代码更易读和维护。
- Redis : 引入 Redis 作为内存数据结构存储，主要用于：
  
  - 缓存 : 缓存频繁读取的数据，如用户列表、帖子列表、单个帖子详情、评论列表、标签信息等。这显著提高了读取速度，减轻了数据库的压力。
  - Session 存储 : 使用 connect-redis 将用户 Session 存储在 Redis 中，实现了分布式 Session 管理，方便未来扩展。
  - 验证码存储 : 临时存储手机验证码，并设置过期时间。
- bcrypt : 使用 bcrypt 库对用户密码进行加盐哈希存储。这是一种安全的密码存储方式，即使数据库泄露，攻击者也难以获取用户明文密码。
- express-session : 用于管理用户 Session，通过 Session 识别用户身份，实现登录状态的维护。结合 Redis 存储，Session 数据可以在多个后端实例间共享。
- cors : 配置 CORS 中间件，允许前端应用 ( http://localhost:5173 ) 跨域访问后端 API，并允许携带 cookie (用于 Session)。
### 项目结构
```
backend/
├── app.js                 # 应用入口文件
├── dbConfig.js           # 数据库配置文件
├── package.json          # 项目依赖配置
├── backend.bat           # Windows 启动脚本
├── routes/               # 路由模块
│   ├── users.js         # 用户相关路由
│   ├── posts.js         # 帖子相关路由
│   ├── pets.js          # 宠物相关路由
│   └── search.js        # 搜索相关路由
├── consumers/            # 消费者模块
├── dist/                 # 构建输出目录
└── src/                  # 源码目录
```
## 核心功能模块
### 1. 用户认证模块 (users.js) 功能特性
- 多种登录方式 : 支持手机号+验证码或手机号+密码的注册和登录流程
- 密码安全 : 注册时对密码进行 bcrypt 哈希加密存储
- Session 管理 : 登录成功后，使用 express-session 在服务器端创建 Session，并将用户关键信息 (ID, username, avatar 等) 存储在 Session 中
- 状态维护 : Session ID 通过 cookie 发送给前端，实现登录状态的持久化 主要接口
- POST /api/register - 用户注册
- POST /api/login - 用户登录
- GET /api/me - 获取当前登录用户信息
- POST /api/logout - 用户登出
- GET /api/cacheUsers - 获取用户列表（带缓存） 安全特性
- Session 认证是一种常见的状态ful认证方式，实现相对简单
- 用户信息存储在服务器端，安全性较高（相对于客户端存储敏感信息）
- 密码哈希存储，防止明文泄露
### 2. 帖子管理模块 (posts.js) 功能特性
- 帖子CRUD : 完整的帖子创建、读取、更新、删除功能
- 排序支持 : 帖子列表支持按创建时间或点赞数排序
- 评论系统 : 完整的评论添加和获取功能
- 点赞功能 : 帖子点赞/取消点赞功能
- 标签关联 : 帖子发布时支持关联标签 主要接口
- GET /api/posts - 获取帖子列表（支持排序参数）
- GET /api/posts/:id - 获取单个帖子详情
- POST /api/posts - 发布新帖子
- GET /api/posts/:id/comments - 获取帖子评论列表
- POST /api/posts/:id/comments - 添加评论
- POST /api/posts/:id/like - 点赞/取消点赞 性能优化
- 提供了完整的帖子生命周期管理 API
- 结合 Redis 缓存提高访问效率
- 发布新帖子或更新帖子时，主动清理相关的列表和详情缓存
### 3. 宠物信息模块 (pets.js) 功能特性
- 宠物档案 : 完整的宠物信息管理
- 用户关联 : 宠物信息与用户账户关联
- 信息展示 : 支持宠物基本信息、照片等多维度展示 主要接口
- GET /api/pets - 获取所有宠物信息（带缓存）
- POST /api/pets - 发布宠物信息 数据结构
- 包含宠物名称、类型、年龄、性别、描述、照片等完整信息
- 联表查询用户信息，提供宠物主人的用户名和头像
### 4. 搜索功能模块 (search.js) 功能特性
- 多维度搜索 : 支持按关键词搜索宠物和帖子
- 搜索历史 : 为登录用户保存和查询搜索历史记录
- 热搜功能 : 通过 tags 表记录关键词的搜索次数，按计数排序获取热搜列表
- 标签搜索 : 支持按标签名称查询相关帖子 主要接口
- GET /api/search/pets - 搜索宠物
- GET /api/search/posts - 搜索帖子
- GET /api/search/history - 获取搜索历史
- GET /api/search/hot - 获取热搜关键词
- GET /api/search/tags/:tagName - 按标签搜索帖子 优化策略
- 提供了多种搜索维度，提升用户体验和内容发现能力
- 异步保存搜索记录，避免阻塞主搜索流程
- 智能去重，避免重复保存相同的搜索记录
## 性能优化策略
### 1. Redis 缓存系统 缓存策略
- Read-Through 模式 : 先检查缓存，如果命中则直接返回；如果未命中，则查询数据库，并将结果写入缓存
- Write-Through/Write-Around 模式 : 在数据发生修改时，主动删除相关的 Redis 缓存 Key，确保下次读取时能获取到最新数据
- 缓存分层 : 对于列表数据，修改任何一项都会清除整个列表缓存 缓存应用场景
- 用户列表缓存（1小时TTL）
- 帖子列表缓存（按排序参数分别缓存，1天TTL）
- 单个帖子详情缓存（1天TTL）
- 评论列表缓存（1天TTL）
- 宠物信息缓存（1天TTL）
- 标签信息缓存（1天TTL） 性能收益
- 大幅减少数据库查询次数，降低数据库负载
- 提高 API 响应速度，尤其对于读多写少的场景效果显著
- 支持高并发访问，提升用户体验
### 2. 数据库优化 连接池管理
- 使用 mysql2/promise 的连接池 (mysqlPool) 来管理数据库连接
- 避免了频繁创建和关闭数据库连接的开销
- 提高了数据库访问效率和并发处理能力 查询优化
- 使用联表查询减少多次数据库访问
- 合理设计索引，提高查询效率
- 参数化查询，防止 SQL 注入攻击
### 3. 异步编程
- 全面使用 async/await : 处理数据库和 Redis 的异步操作
- 代码可读性 : 使异步代码看起来像同步代码，提高了代码的可读性和可维护性
- 避免回调地狱 : 通过 Promise 和 async/await 避免了传统回调函数的嵌套问题
## 安全特性
### 1. 身份认证与授权
- Session 验证中间件 : 实现了 verifySession 中间件，确保敏感操作需要用户登录
- 分布式 Session : 使用 Redis 存储 Session，支持多实例部署
- 安全的密码存储 : 使用 bcrypt 进行密码哈希，加盐存储
### 2. 数据验证
- 参数校验 : 对所有输入参数进行严格校验
- SQL 注入防护 : 使用参数化查询防止 SQL 注入
- 排序参数白名单 : 对排序字段进行白名单验证，防止恶意查询
### 3. 跨域安全
- CORS 配置 : 精确配置允许的前端域名
- Cookie 安全 : 配置 httpOnly 和 secure 属性
- Session 安全 : 设置合理的过期时间和安全策略